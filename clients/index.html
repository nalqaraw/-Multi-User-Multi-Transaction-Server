<!DOCTYPE html>
<html lang="en">
  <head>
      <!-- <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat App</title>

    <link
      href="https://fonts.googleapis.com/css?family=Roboto&display=swap"
      rel="stylesheet"
    /> -->

    <link rel="stylesheet" href="style.css" /> 

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"
      integrity="sha512-PU5S6BA03fRv1Q5fpwXjg5nlRrgdoguZ74urFInkbABMCENyx5oP3hrDzYMMPh3qdLdknIvrGj3yqZ4JuU7Nag=="
      crossorigin=" "
      referrerpolicy="no-referrer"
    ></script> 
  </head>

  <body>
    <div class="application">
      <div >
        <div id="sidebar" class="leftSide">
             <span class="colored"></span></span>
          </div>

          <span ></span>
          <div id="active_users_list"></div>
        </div>

        <div class="chatInnerSpace">
          <div class="chatBackground">
            <div id="chat" class="chat"></div>

            <div class="chatText">
              <input
                type="text"
                id="messageInput"
                placeholder="Enter message"
              />
              <button id="send_message_btn" class="sendMessageButton" id="send">
                SEND
              </button>
            </div>
          </div>
        </div>

        <div class="rightSide">
          <span class="roomList">Rooms</span>
          <div id="active_rooms_list" class="activeRoomList"></div>

          <div >
            <input type="text" id="roomInput" placeholder="Create room" />
            <button id="room_add_icon_holder" class="addRoom">
              +
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      
      var socket = io();

      var userlist = document.getElementById("active_users_list");
      var roomlist = document.getElementById("active_rooms_list");
      var message = document.getElementById("messageInput");
      var sendMessageBtn = document.getElementById("send_message_btn");
      var roomInput = document.getElementById("roomInput");
      var createRoomBtn = document.getElementById("room_add_icon_holder");
      var chatDisplay = document.getElementById("chat");

      var currentRoom = "main";
      var guestName = "";

      // Prompt for guest name on connecting to server
      socket.on("connect", function () {
          guestName = prompt("Enter name: ");
        socket.emit("addGuest", guestName);
      });

      // Send message on button click
      sendMessageBtn.addEventListener("click", function () {
        socket.emit("sendMessage", message.value);
        message.value = "";
      });

      // Send message on enter key press
      message.addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
          sendMessageBtn.click();
        }
      });

      // Create new room on button click
      createRoomBtn.addEventListener("click", function () {
        // socket.emit("createRoom", prompt("Enter new room: "));
        let roomName = roomInput.value.trim();
        if (roomName !== "") {
          socket.emit("createRoom", roomName);
          roomInput.value = "";
        }
      });

      socket.on("updateChat", function (username, data) {
        if (username === "INFO") {
          console.log("Displaying announcement");
          chatDisplay.innerHTML += `<div ><span>${data}</span></div>`;
        } else {
          console.log("Displaying user message");
          chatDisplay.innerHTML += `<div  ${
            username === guestName ? "me" : ""
          }">
                                      <div >
                                        <div id="message" >
                                          <span >${username}</span>
                                          <span >${data}</span>
                                        </div>
                                      </div>
                                    </div>`;
        }

        chatDisplay.scrollTop = chatDisplay.scrollHeight;
      });

      socket.on("updateUsers", guests => {
        userlist.innerHTML = "";
        console.log("Guest names returned from server", guests);
        for (var g in guests) {
          userlist.innerHTML += `<div >
                                    <span>${g}</span>
                                  </div>`;
        }
      });

      socket.on("updateRooms", function (rooms, newRoom) {
        roomlist.innerHTML = "";

        for (var index in rooms) {
          roomlist.innerHTML += `<div  id="${rooms[index].name}"
                                      onclick="changeRoom('${rooms[index].name}')">
                                      <div >
                                          <div >
                                          <span >#${rooms[index].name}</span>
                                          <span >${rooms[index].creator}</span>
                                          </div>
                                      </div>
                                  </div>`;
        }

        document.getElementById(currentRoom).classList.add("active_item");
      });

      function changeRoom(room) {
        if (room != currentRoom) {
          socket.emit("updateRooms", room);
          document.getElementById(currentRoom).classList.remove("active_item");
          currentRoom = room;
          document.getElementById(currentRoom).classList.add("active_item");
        }
      }
    </script>
  </body>
</html>